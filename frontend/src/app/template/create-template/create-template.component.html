<div class="register-container">
  <form class="register-form" [formGroup]="templateForm" (ngSubmit)="onCreate()">
    <h2 class="register-title">Certificate Template</h2>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Name</mat-label>
      <input matInput formControlName="name" placeholder="Enter template name">
      <mat-error *ngIf="templateForm.get('name')?.hasError('required')">
        Name is required
      </mat-error>
    </mat-form-field>

    <div class="issuer-table-container">
      <h5>Available Issuer Certificates</h5>

      <table mat-table [dataSource]="dataSource" class="mat-elevation-z1 full-width">

        <ng-container matColumnDef="serialNumber">
          <th mat-header-cell *matHeaderCellDef>Serial Number</th>
          <td mat-cell *matCellDef="let cert">{{ cert.serialNumber }}</td>
        </ng-container>

        <ng-container matColumnDef="certificateType">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let cert">{{ cert.certificateType }}</td>
        </ng-container>

        <ng-container matColumnDef="issuerEmail">
          <th mat-header-cell *matHeaderCellDef >Issuer Mail</th>
          <td mat-cell *matCellDef="let cert">{{ cert.issuerEmail }}</td>
        </ng-container>

        <ng-container matColumnDef="subjectEmail">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Subject Mail</th>
          <td mat-cell *matCellDef="let cert">{{ cert.subjectEmail }}</td>
        </ng-container>

        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef> Select </th>
          <td mat-cell *matCellDef="let cert">
            <button mat-button color="primary" (click)="selectIssuer(cert)">
              {{ selectedIssuer?.serialNumber === cert.serialNumber ? 'Selected' : 'Select' }}
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"
            [class.selected-row]="selectedIssuer?.serialNumber === row.serialNumber">
        </tr>
      </table>

      <mat-paginator [length]="totalElements"
                     [pageSize]="pageSize"
                     [pageSizeOptions]="[5, 10, 25]"
                     (page)="onPageChange($event)">
      </mat-paginator>

      <div *ngIf="!selectedIssuer" class="issuer-warning">
        <small>Please select an issuer certificate.</small>
      </div>
    </div>


    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Common Name Regex</mat-label>
      <input matInput formControlName="commonNameRegex" placeholder="e.g. .*\.example\.com">
      <mat-error *ngIf="templateForm.get('commonNameRegex')?.hasError('required')">
        Common Name Regex is required
      </mat-error>
      <mat-error *ngIf="templateForm.get('commonNameRegex')?.hasError('invalidRegex')">
        Invalid regular expression
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>SAN Regex</mat-label>
      <input matInput formControlName="sanRegex" placeholder="e.g. .*">
      <mat-error *ngIf="templateForm.get('sanRegex')?.hasError('required')">
        SAN Regex is required
      </mat-error>
      <mat-error *ngIf="templateForm.get('sanRegex')?.hasError('invalidRegex')">
        Invalid regular expression
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>TTL (Days)</mat-label>
      <input matInput type="number" formControlName="ttlDays" placeholder="Enter days to live">
      <mat-error *ngIf="templateForm.get('ttlDays')?.hasError('required')">
        TTL is required
      </mat-error>
      <mat-error *ngIf="templateForm.get('ttlDays')?.hasError('min')">
        TTL must be at least 1 day
      </mat-error>
    </mat-form-field>

    <div class="usage-row">
      <div class="usage-col">
        <h5>Key Usages</h5>
        <div *ngFor="let option of keyUsageOptions" class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            [value]="option"
            (change)="onCheckboxChange($event, 'keyUsages')">
          <label class="form-check-label">{{ option }}</label>
        </div>
      </div>

      <div class="usage-col">
        <h5>Extended Key Usages</h5>
        <div *ngFor="let option of extendedKeyUsageOptions" class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            [value]="option"
            (change)="onCheckboxChange($event, 'extendedKeyUsages')">
          <label class="form-check-label">{{ option }}</label>
        </div>
      </div>
    </div>

    <button mat-raised-button color="primary" type="submit"
            class="save-button" [disabled]="templateForm.invalid">
      Save Template
    </button>
  </form>
</div>
